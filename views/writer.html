<!doctype html>
<html lang="en">

<head>
    {% include 'head.html' %}
    <meta name="robots" content="noindex" />

    <title>{{ title }} &mdash; EExpress</title>
</head>

<body class="flex flex-col items-center overflow-x-hidden">
    {% include 'nav.html' %}

    <main class="my-8 grid h-max w-full max-w-6xl grid-cols-1 gap-8 px-4 md:grid-cols-[1fr_18rem]">
        <article id="writer" class="w-full">
            <header class="mb-8 border-b-2 border-black">
                <textarea type="text" id="article-title" placeholder="หัวข้อบทความ" class="w-full resize-none bg-gray-100 px-2 py-4 text-6xl font-bold leading-relaxed">{{ article.title }}</textarea>
                <textarea type="text" id="article-description" placeholder="คำอธิบาย" class="w-full resize-none bg-gray-100 px-2 py-4">{{ article.description }}</textarea>
            </header>

            <!-- <img src="/images/articles/66344784815d6d5d003ed32a/d5c4aae0-14a7-4013-a1c0-ac0b0a36c638.webp" class="border-2 border-transparent my-4" /> -->
            {% for block in article.content %} {% if block.tag == 'img'%}
            <!--  -->
            <img src="/images/articles/{{ article._id.toString() }}/{{ block.src }}" class="mb-2 border-2 border-transparent" />
            {% else %}
            <!--  -->
            {% if block.style.startsWith('heading') %}
            <textarea class="heading w-full resize-none bg-gray-100 px-2 py-4 min-h-12 h-auto text-4xl font-bold" placeholder="หัวข้อ">{{ block.text }}</textarea>
            
            {% elif block.style.startsWith('paragraph') %}
            <textarea class="paragraph w-full resize-none bg-gray-100 px-2 py-4 min-h-12 h-auto text-lg" placeholder="หัวข้อ">{{ block.text }}</textarea>
            <!--  -->
            {% endif %}
            {% endif %}
            <!--  -->
            {% endfor %}
        </article>

        <section class="sticky top-[calc(4rem_+_2rem_+_2px)] flex h-max max-h-[calc(100dvh_-_6rem)] w-full flex-col gap-2 border-2 border-black p-2 font-sans">
            <p class="font-bold">เพิ่มส่วน</p>
            <div class="flex flex-col gap-2">
                <div class="grid grid-cols-2 gap-2">
                    <button class="flex min-h-12 w-full items-center justify-center border-2 border-black font-bold duration-100 hover:bg-black hover:text-white" onclick="writer.insert('heading')">
                        หัวข้อ
                    </button>
                    <button class="flex min-h-12 w-full items-center justify-center border-2 border-black font-bold duration-100 hover:bg-black hover:text-white" onclick="writer.insert('paragraph')">
                        เนื้อความ
                    </button>
                </div>

                <hr />
                <button class="flex min-h-12 w-full items-center justify-center border-2 border-black font-bold duration-100 hover:bg-black hover:text-white" onclick="writer.insert('image')">
                    รูปภาพ
                </button>
            </div>

            <menu class="hidden h-max w-full flex-col gap-2" id="SX_MENU_IMG_OPTIONS">
                <p class="font-bold">รูปภาพ</p>
                <div class="grid grid-cols-2 gap-2">
                    <button class="flex min-h-12 w-full items-center justify-center border-2 border-black font-bold duration-100 hover:bg-black hover:text-white" onclick="writer.replaceImage()">
                        แทนที่
                    </button>
                    <button class="flex min-h-12 w-full items-center justify-center border-2 border-black font-bold duration-100 hover:bg-black hover:text-white" onclick="writer.removeImage()">
                        ลบรูปภาพ
                    </button>
                </div>
            </menu>

            <menu class="h-max w-full flex-col gap-2" id="SX_MENU_SAVING_OPTIONS">
                <p class="font-bold">ตัวเลือก</p>
                <div class="grid auto-cols-auto gap-2">
                    <button class="flex min-h-12 w-full items-center justify-center border-2 border-black font-bold duration-100 hover:bg-black hover:text-white" onclick="writer.update()">
                        <input type="checkbox" class="peer hidden" id="isloading" />
                        <span class="hidden h-4 w-4 animate-spin rounded-full border-2 border-black border-t-gray-300 peer-checked:block"></span>
                        <div class="flex items-center justify-center gap-2 peer-checked:hidden">
                            <p>บันทึก</p>
                        </div>
                    </button>
                    <a href="/managers/articles" class="flex min-h-12 w-full items-center justify-center border-2 border-black font-bold duration-100 hover:bg-black hover:text-white">
                        <div class="flex items-center justify-center gap-2">
                            <p>กลับหน้าหลัก</p>
                        </div>
                    </a>
                </div>
            </menu>
        </section>
    </main>

    <script>
        const WRITER_CONTAINER = document.getElementById("writer");
        const SX_MENU_IMG_OPTIONS = document.getElementById(
            "SX_MENU_IMG_OPTIONS",
        );
        const SX_MENU_SAVING_OPTIONS = document.getElementById(
            "SX_MENU_SAVING_OPTIONS",
        );
        const BASE_IMAGE_ROUTE = "/images/articles/{{ article._id.toString() }}";

        class WriterGetImage {
            constructor(callback = (filename = String) => { }) {
                const input = document.createElement("input");
                input.setAttribute("type", "file");
                input.setAttribute("accept", "image/*");

                input.onchange = async (e) => {
                    const fd = new FormData();
                    fd.append("image", e.target.files[0]);
                    const res = await fetchJson("/article/image/{{ article._id.toString() }}", {
                        method: "POST",
                        body: fd,
                    },);

                    if (res.status === 201) return callback(res.filename);
                    else new Alert(res.message, AlertType.ERROR, true);
                };

                input.click();
            }
        }

        class Writer {
            constructor(container = document.getElementById()) {
                this.container = container;
                this.select = null;

                this.update_timeout = 2000;
                this.timeout_object = setTimeout(() => { }, this.update_timeout);

                this.container.querySelectorAll("textarea").forEach((e) => {
                    this.initTextInput(e);
                });

                this.container.querySelectorAll("img").forEach((e) => {
                    this.initImage(e);
                });
            }

            unSelectImage() {
                SX_MENU_IMG_OPTIONS.classList.add("hidden");
                this.container
                    .querySelectorAll("img")
                    .forEach((e) => (e.classList = "border-2 border-transparent mb-2"));
            }

            initTextInput(obj = document.getElementById()) {
                obj.setAttribute(
                    "style",
                    "height:" + obj.scrollHeight + "px;overflow-y:hidden;",
                );
                obj.addEventListener("input", OnTextInput, false);
                obj.addEventListener("keydown", OnKeydown, false);
                obj.addEventListener("focus", (e) => {
                    this.unSelectImage();
                    this.select = obj;
                });

                obj.addEventListener("keypress", () => this.update(), false);
            }

            initImage(obj = document.getElementById()) {
                obj.addEventListener("click", (e) => {
                    obj.classList.remove("border-transparent");
                    obj.classList.add("border-black", "rounded");

                    this.select = obj;
                    SX_MENU_IMG_OPTIONS.classList.remove("hidden");
                });
            }

            createTextInput(template) {
                const template_title = {
                    heading: "หัวข้อ",
                    paragraph: "เนื้อความ",
                };

                const textarea = document.createElement("textarea");
                textarea.classList =
                    template +
                    " w-full resize-none bg-gray-100 px-2 py-4 min-h-12 h-auto";
                if (template == "heading")
                    textarea.classList.add("text-4xl", "font-bold");

                textarea.setAttribute("placeholder", template_title[template]);
                this.initTextInput(textarea);

                return textarea;
            }

            replaceImage() {
                new WriterGetImage((filename) => {
                    this.select.setAttribute("src", BASE_IMAGE_ROUTE + "/" + filename);
                    this.update();
                });
            }

            removeImage() {
                this.select.remove();
                this.select = null;
                this.unSelectImage();
                this.update();
            }

            createImage() {
                new WriterGetImage((filename) => {
                    const img = document.createElement("img");
                    img.setAttribute("src", BASE_IMAGE_ROUTE + "/" + filename);

                    img.classList = "border-2 border-transparent mb-2";

                    this.select
                        ? this.select.insertAdjacentElement("afterend", img)
                        : this.container.insertAdjacentElement("beforeend", img);
                    this.initImage(img);
                    this.update();
                });
            }

            insert(template) {
                if (
                    this.select &&
                    !["ARTICLE"].includes(this.select.parentElement.tagName)
                )
                    return;
                let object;

                if (["paragraph", "heading"].includes(template))
                    object = this.createTextInput(template);
                if (template == "image") return this.createImage();

                this.select
                    ? this.select.insertAdjacentElement("afterend", object)
                    : this.container.insertAdjacentElement("beforeend", object);
                focus(object);
            }

            content() {
                const title = document.getElementById("article-title").value;
                const description = document.getElementById(
                    "article-description",
                ).value;
                const content = [];

                for (let child of this.container.children) {
                    let data;

                    if (child.tagName == "TEXTAREA" && child.value) {
                        data = {
                            style: child.classList.toString(),
                            text: child.value,
                        };
                    } else if (child.tagName == "IMG" && child.src) {
                        data = {
                            tag: "img",
                            style: child.classList.toString(),
                            src: child.src.split("/").reverse()[0],
                        };
                    } else if (["OL", "UL"].includes(child.tagName)) {
                        data = {
                            tag: child.tagName.toLowerCase(),
                            content: [],
                        };

                        for (let li of child.children) {
                            const textarea = li.querySelector("textarea");
                            data.content.push({
                                style: textarea.classList.toString(),
                                text: textarea.value,
                            });
                        }
                    } else continue;

                    content.push(data);
                }

                return { title, description, content };
            }

            update() {
                clearTimeout(this.timeout_object);
                SX_MENU_SAVING_OPTIONS.querySelector("#isloading").checked = true;

                this.timeout_object = setTimeout(() => fetch("/article/writer/{{ article._id.toString() }}", {
                    headers: {
                        "Content-Type": "application/json",
                    },
                    method: "PUT",
                    body: JSON.stringify(this.content())
                })
                    .then((res) => res.json())
                    .then((res) => {
                        if (res.status !== 200)
                            new Alert(res.message, AlertType.ERROR, true);
                    })
                    .catch((e) => {
                        console.error(e);
                        new Alert("เกิดข้อผิดพลาดบางอย่าง ลองอีกครั้งในภายหลัง", AlertType.ERROR, true);
                    })
                    .finally(() => {
                        SX_MENU_SAVING_OPTIONS.querySelector("#isloading").checked = false;
                    }),
                    this.update_timeout,
                );
            }
        }
    </script>

    <script>
        function OnKeydown(k = new KeyboardEvent()) {
            if (k.code == "Backspace" && !this.value) {
                k.preventDefault();
                if (
                    writer.container.children.length - 1 > 1 &&
                    writer.select.parentElement.tagName == "ARTICLE"
                ) {
                    let currentIndex = 0;
                    for (let i = 0; i < writer.container.children.length; i++)
                        if (writer.container.children[i] == this) currentIndex = i;
                    focus(
                        writer.container.children[
                        currentIndex - 1 >= 0 ? currentIndex - 1 : 0
                        ],
                    );

                    this.remove();
                }

                writer.update();
            }

            if (k.code == "Enter") {
                k.preventDefault();

                console.log(writer.select.parentElement.tagName);
                if (writer.select.parentElement.tagName == "ARTICLE")
                    writer.insert("paragraph");
                if (writer.select.parentElement.tagName == "LI") writer.insert("li");
            }

            if (
                (k.code == "ArrowUp" && this.selectionStart == 0) ||
                (k.ctrlKey && k.code == "ArrowUp")
            ) {
                let currentIndex = 0;
                for (let i = 0; i < writer.container.children.length; i++)
                    if (writer.container.children[i] == this) currentIndex = i;
                if (
                    ["UL", "OL"].includes(
                        writer.container.children[
                            currentIndex - 1 >= 0 ? currentIndex - 1 : 0
                        ].tagName,
                    )
                )
                    currentIndex++;
                focus(
                    writer.container.children[
                    currentIndex - 1 >= 0 ? currentIndex - 1 : 0
                    ],
                );
            }

            if (
                (k.code == "ArrowDown" && this.selectionStart == this.value.length) ||
                (k.ctrlKey && k.code == "ArrowDown")
            ) {
                let currentIndex = 0;
                for (let i = 0; i < writer.container.children.length; i++)
                    if (writer.container.children[i] == this) currentIndex = i;
                focus(
                    writer.container.children[
                    currentIndex + 1 >= writer.container.children.length - 1
                        ? writer.container.children.length - 1
                        : currentIndex + 1
                    ],
                );
            }
        }

        function OnTextInput() {
            this.style.height = "auto";
            this.style.height = this.scrollHeight + "px";
        }

        function focus(obj = document.getElementById()) {
            return obj.focus();
        }
    </script>

    <script>
        const writer = new Writer(WRITER_CONTAINER);
    </script>

    {% if !article.content or article.content.length == 0 %}
    <script>writer.insert("paragraph")</script>
    {% if endif %}
    <!--  -->
    {% include 'cartview.html' %}
    <!--  -->
    {% include 'footer.html' %}
</body>

</html>